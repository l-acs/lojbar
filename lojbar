#!/bin/clojure
; -*-Clojure-*-
(require '[clojure.string :as str])
(use '[clojure.java.shell :only [sh]])
(import 'java.lang.Runtime)


(def fore "%{F#FFFFFF}")
(def back "%{B#222222}")


(defn makebutton [message action button]
  (str "%{A" button ":" action ":}" message "%{A}"))


(defn makebuttons [message actions button]
  ;%{A1:action:}%{A3:action:}...%{A}%{A}
  (if (empty? actions)
    message
    (makebuttons
     (makebutton message (first actions) button)
     (rest actions)
     (+ button 1))))



(defn music []
  (str
   (makebuttons "  <  " '("mpc prev" "b" "mpc seek 0") 1)
   (makebuttons
    (first (str/split (:out (sh "mpc" "status")) #"\n"))
    '("mpc toggle" "mpc toggle" "mpc toggle" "mpc volume +5" "mpc volume -5") 1)
   (makebuttons "  >  " '("mpc next" "b" "mpc next") 1)))



(defn getwm []
  (second
   (str/split
    (first
     (str/split
      (:out (sh "wmctrl" "-m"))
      #"\n"))
    #"\s")))



(defn getdesktoplist []
  (def base
    (:out
     (sh "wmctrl" "-d")))
  (map
   #(str/split % #"\s")
   (str/split base #"\n")))


(defn getwindows [desktop] ;desktop is one line of the output of wmctrl -d
  (:out
   (sh "/home/l-acs/.scripts/window/act.sh" "--getwindowsfordesktop"
       (str
        (get (vec desktop) 0)))))

(defn isactive? [desktop]
  (= "*" (get (vec desktop) 2)))

(defn haswindows? [desktop]
  (not (str/blank? (getwindows desktop))))

(defn getname [desktop]
  (get (vec desktop) 13))


(defn desktops []
  (def count 0)
  (makebuttons 
   (str/join 
    (map
     (fn [d]
       (def count (+ count 1))
       (makebuttons d
                    (list (str "$HOME/.scripts/window/act.sh -f " count) " " (str "$HOME/.scripts/window/act.sh -s " count)) 1))
     (map (fn [x] (str " " x " ")) (map getname (getdesktoplist)))))
   (list "$HOME/.scripts/window/act.sh -f next" "$HOME/.scripts/window/act.sh -f prev")
   4
   ))


(defn date [] (get (vec (str/split (:out (sh "date" "+%A, %B %-d, %Y - %I:%M%P")) #"\n")) 0))


(println
 fore back
 "%{l}   " (desktops)
 "%{c}"  (music)
 "%{r}" (date)
 "   " )


(shutdown-agents) ;without this it hangssss

